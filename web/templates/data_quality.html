{% extends "base.html" %}

{% block title %}Data Quality - Pocket Link Manager{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="data-quality-page">
    <div class="header-with-actions">
        <div class="header-title-group">
            <h1><i data-lucide="bar-chart"></i> Data Quality</h1>
            <span class="badge badge-info">System Health Dashboard</span>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('main.add_link') }}" class="btn btn-primary">
                <i data-lucide="plus"></i> Add New Link
            </a>
        </div>
    </div>
    
    <!-- Overview Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--secondary-color);">
                <i data-lucide="link"></i>
            </div>
            <h3>Total Links</h3>
            <p class="stat-number">{{ stats.total_links | number_format }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--success-color);">
                <i data-lucide="check-circle"></i>
            </div>
            <h3>Accessible</h3>
            <p class="stat-number">{{ stats.accessible_links | number_format }}</p>
            <p class="stat-percent">{{ stats.accessibility_rate }}% success rate</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--primary-color);">
                <i data-lucide="book-open"></i>
            </div>
            <h3>Unread</h3>
            <p class="stat-number">{{ stats.pocket_status.unread | default(0) | number_format }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--text-muted);">
                <i data-lucide="archive"></i>
            </div>
            <h3>Archived</h3>
            <p class="stat-number">{{ stats.pocket_status.archive | default(0) | number_format }}</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--success-color);">
                <i data-lucide="file-text"></i>
            </div>
            <h3>Content Extraction</h3>
            <p class="stat-number">{{ stats.content_stats.content_rate }}%</p>
            <p class="text-muted">{{ stats.content_stats.with_content | number_format }} links with full content</p>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--primary-color);">
                <i data-lucide="markdown"></i>
            </div>
            <h3>Markdown Output</h3>
            <p class="stat-number">{{ stats.markdown_stats.markdown_rate }}%</p>
            <p class="text-muted">{{ stats.markdown_stats.with_markdown | number_format }} files ready for Obsidian</p>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="card-header">
                <h2><i data-lucide="bar-chart-2"></i> Status Code Breakdown</h2>
            </div>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="card-header">
                <h2><i data-lucide="pie-chart"></i> Quality Distribution</h2>
            </div>
            <div class="chart-container">
                <canvas id="qualityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Status Code Breakdown Table -->
    <div class="card">
        <div class="card-header">
            <h2><i data-lucide="list"></i> Status Code Breakdown</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Status Code</th>
                        <th>Links Count</th>
                        <th>Distribution</th>
                        <th style="width: 150px;">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code, count in stats.status_code_breakdown.items() | sort %}
                    <tr>
                        <td style="font-weight: 700;">
                            {% set status_class = '0xx' %}
                            {% if code == '200' %}{% set status_class = '2xx' %}
                            {% elif code == '403' or code == '404' or code == '4XX' %}{% set status_class = '4xx' %}
                            {% elif code == '5XX' %}{% set status_class = '5xx' %}
                            {% elif code|int >= 200 and code|int < 300 %}{% set status_class = '2xx' %}
                            {% elif code|int >= 300 and code|int < 400 %}{% set status_class = '3xx' %}
                            {% elif code|int >= 400 and code|int < 500 %}{% set status_class = '4xx' %}
                            {% elif code|int >= 500 %}{% set status_class = '5xx' %}
                            {% endif %}
                            <span class="status-code status-{{ status_class }}">
                                {{ code }}
                            </span>
                        </td>
                        <td>{{ count | number_format }}</td>
                        <td>
                            {% set pct = (count / stats.total_links * 100) %}
                            <div class="progress-bar-container" style="margin-top: 0;">
                                <div class="progress-bar" style="width: {{ pct }}%; background-color: var(--secondary-color);"></div>
                            </div>
                        </td>
                        <td style="font-weight: 600;">{{ "%.1f" | format(pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Top Domains Table -->
    <div class="card">
        <div class="card-header">
            <h2><i data-lucide="globe"></i> Top Domains</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Total Links</th>
                        <th>Success Rate</th>
                        <th>Avg Quality</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in stats.top_domains[:10] %}
                    <tr>
                        <td style="font-weight: 500;">{{ domain.domain }}</td>
                        <td>{{ domain.total }}</td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: {{ domain.success_rate }}%; background-color: {% if domain.success_rate >= 90 %}var(--success-color){% elif domain.success_rate >= 70 %}var(--warning-color){% else %}var(--danger-color){% endif %};"></div>
                                <span class="progress-label">{{ domain.success_rate }}%</span>
                            </div>
                        </td>
                        <td>
                            <span class="quality-score quality-{{ 'high' if domain.avg_quality_score >= 60 else 'medium' if domain.avg_quality_score >= 40 else 'low' }}">
                                {{ domain.avg_quality_score }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('main.links', domain=domain.domain) }}" class="btn btn-sm btn-secondary">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.header-with-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.header-title-group {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.header-title-group h1 {
    margin-bottom: 0;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.stat-icon {
    margin-bottom: var(--spacing-sm);
}

.stat-icon i {
    width: 24px;
    height: 24px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.card-header h2 {
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.card-header h2 i {
    color: var(--primary-color);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background-color: var(--border-color);
    border-radius: 4px;
    position: relative;
    margin-top: 4px;
}

.progress-bar {
    height: 100%;
    border-radius: 4px;
}

.progress-label {
    font-size: 0.75rem;
    position: absolute;
    right: 0;
    top: -18px;
    color: var(--text-muted);
}

.stat-percent {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 4px;
}
</style>

<script>
// Configure Chart.js defaults for modern look
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.color = '#636e72';
Chart.defaults.plugins.legend.labels.usePointStyle = true;

// Status code chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const labels = {{ stats.status_code_breakdown.keys() | list | tojson }};
const data = {{ stats.status_code_breakdown.values() | list | tojson }};

// Map labels to colors
const colorMap = {
    '200': 'rgba(39, 174, 96, 0.7)',   // Green
    '403': 'rgba(241, 196, 15, 0.7)',  // Yellow/Orange
    '404': 'rgba(231, 76, 60, 0.7)',   // Red
    '4XX': 'rgba(231, 76, 60, 0.5)',   // Lighter Red
    '5XX': 'rgba(155, 89, 182, 0.7)'   // Purple
};

const backgroundColors = labels.map(label => colorMap[label] || 'rgba(52, 152, 219, 0.7)');

const statusData = {
    labels: labels,
    datasets: [{
        label: 'Links',
        data: data,
        backgroundColor: backgroundColors,
        borderRadius: 6,
        borderWidth: 0
    }]
};
new Chart(statusCtx, {
    type: 'bar',
    data: statusData,
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { 
                beginAtZero: true,
                grid: { display: true, drawBorder: false, color: '#f1f2f6' }
            },
            y: {
                grid: { display: false }
            }
        }
    }
});

// Quality distribution chart
const qualityCtx = document.getElementById('qualityChart').getContext('2d');
const qualityData = {
    labels: {{ stats.quality_distribution.keys() | list | tojson }},
    datasets: [{
        data: {{ stats.quality_distribution.values() | list | tojson }},
        backgroundColor: [
            'rgba(39, 174, 96, 0.7)',
            'rgba(52, 152, 219, 0.7)',
            'rgba(241, 196, 15, 0.7)',
            'rgba(231, 76, 60, 0.7)',
        ],
        borderWidth: 2,
        borderColor: '#ffffff'
    }]
};
new Chart(qualityCtx, {
    type: 'doughnut',
    data: qualityData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'right',
                labels: { padding: 20 }
            }
        }
    }
});
</script>
{% endblock %}
